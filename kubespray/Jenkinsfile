pipeline {
	agent any

	stages {
		stage("Git Checkout && pull terraform img"){
      			steps{
            			checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'kubespray']]]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitCred', url: 'https://github.com/erahaouisamia/repo_idemia/']]])
			}
    		}
		stage('terraform'){
		      	agent{
				docker{
			      		image 'hashicorp/terraform'
				}
		      	}
			steps{						//sh label: '', script: 'cd kubespray/contrib/terraform/aws/terraform'
				sh label: '', script: 'docker run -w /app -v /root/.aws:/root/.aws -v `pwd`:/app hashicorp/terraform init /app/contrib/terraform/aws/'
				sh label: '', script: 'docker run -w /app -v /root/.aws:/root/.aws-v `pwd`:/app hashicorp/terraform plan /app/contrib/terraform/aws/kubespray -var-file=credentials.tfvars'
				sh label: '', script: 'docker run -w /app -v /root/.aws:/root/.aws -v `pwd`:/app hashicorp/terraform apply "/app/contrib/terraform/aws/kubespray"'
			}
		}
		stage('Ansible') {
			agent{
				docker{
					image 'geektechstuff/ansible_container'
				 }
			 }
			 steps {
				dir("kubespray"){
					sh label: '', script: 'docker run geektechstuff/ansible_container -i ./inventory/hosts ./cluster.yml -e ansible_user=core -b --become-user=root --flush-cache'
				}
		      	    }
		}
  }
}
