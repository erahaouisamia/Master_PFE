pipeline {
	agent{
		node{
			label 'master'
		}
	}
	triggers {
		pollSCM('* * * * *') //runs this pipeline on every commit
		//cron('30 23 * * *') //run at 23:30:00 
    	}

	stages {
		stage('Git Checkout'){
			steps{
				cleanWs()
				checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'SparseCheckoutPaths', sparseCheckoutPaths: [[path: 'app']]]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'gitCred', url: 'https://github.com/erahaouisamia/repo_idemia/']]])
			}
        	}
        	stage('Backend') {
			agent{
				docker{
					image 'maven:3.6.3-openjdk-8'
				}
			}
			stages{
				stage('Compile'){
					steps {
						dir("${env.WORKSPACE}/app/crud-api")
						{
							sh label: '', script: 'mvn clean compile'
			    			}
					}
				}
				stage('build jar'){
					steps{
						dir("${env.WORKSPACE}/app/crud-api"){
							sh 'mvn clean package'
						}
					}
				}
			}
		}
		stage ('docker image build api')
		{
			steps {
				dir("${env.WORKSPACE}/app/crud-api"){
					sh 'ls target'
					sh 'docker build -t backend:v1 -f Dockerfile .'
				}
			}
		}
		stage('Frontend'){
			agent {
				docker { image 'node:latest' }
			}
			stages {
				//verifier l'installation de npm
				stage('Install') {
					steps {
						dir("${env.WORKSPACE}/app/crud-frontend")
						{
							sh 'npm install'
						}
					}
				}
				stage('Build') {
					steps { 
						dir("${env.WORKSPACE}/app/crud-frontend")
						{
							sh 'npm run build -- --prod' 
						}
					}
				}
			}
		}
		stage ('docker image build frontend'){
			steps {
				dir("${env.WORKSPACE}/app/crud-frontend"){
					sh 'docker build -t frontend:v1 .' 
				}
			}
		}
        	stage ('docker image push to Nexus') {
		    steps {
			withCredentials(usernamePassword(credentialsId: 'nexus-registry', usernameVariable: 'nexus_user', passwordVariable: 'nexus_password')){
				sh 'docker login -u \$nexus_user -p \$nexus_password http://3.9.82.208:8083'
				sh 'docker push backend:v1'
				sh 'docker push frontend:v1'
			}
		    }
        	}
		stage ('helm push to Nexus') {
			agent{
				docker{
					image 'alpine/helm'
					args "--entrypoint="
				}
			}
		    	steps {           
				withCredentials([usernamePassword(credentialsId: 'nexus-registry', usernameVariable: 'nexus_user', passwordVariable: 'nexus_password')]){
					sh 'helm plugin install --version master https://github.com/sonatype-nexus-community/helm-nexus-push.git'
					sh 'helm repo add helmRepo http://http://3.9.82.208:8081/repository/helmRepo/ --username \$nexus_user --password \$nexus_password'
					sh 'helm nexus-push helmRepo app/Helm-chart --username \$nexus_user --password \$nexus_password'
				}
		    	}
        	}
    	}
	post {
	    success {
	      deleteDir()
	    }
  	}
}
